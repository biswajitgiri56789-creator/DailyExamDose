name: Test Bot Connection

on:
  workflow_dispatch:

jobs:
  test-bot:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“‚ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ðŸ Setup Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: ðŸ“¦ Install Dependencies
        run: |
          pip install requests
          
      - name: ðŸ”§ Debug Environment
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          echo "ðŸ” Environment Variables:"
          echo "BOT_TOKEN present: $([[ -n \"$BOT_TOKEN\" ]] && echo 'âœ…' || echo 'âŒ')"
          echo "CHAT_ID present: $([[ -n \"$CHAT_ID\" ]] && echo 'âœ…' || echo 'âŒ')"
          echo "BOT_TOKEN length: ${#BOT_TOKEN}"
          echo "CHAT_ID: $CHAT_ID"
          
      - name: ðŸ§ª Test Telegram API
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          echo "ðŸ§ª Testing Telegram API..."
          
          # Create Python test script
          cat > test_telegram.py << 'EOF'
import os
import requests
import json
from datetime import datetime

BOT_TOKEN = os.environ.get('BOT_TOKEN', '')
CHAT_ID = os.environ.get('CHAT_ID', '')

print("ðŸ” Debug Info:")
print(f"BOT_TOKEN first 10 chars: {BOT_TOKEN[:10] if BOT_TOKEN else 'EMPTY'}")
print(f"CHAT_ID: {CHAT_ID}")

# Test 1: Check bot
print("\nðŸ“¡ Test 1: Checking bot...")
try:
    resp = requests.get(f"https://api.telegram.org/bot{BOT_TOKEN}/getMe", timeout=10)
    print(f"Bot Status: {resp.status_code}")
    print(f"Bot Response: {resp.text}")
except Exception as e:
    print(f"âŒ Error checking bot: {e}")

# Test 2: Send message
print("\nðŸ“¤ Test 2: Sending message...")
message = f"""
ðŸ§ª TEST MESSAGE ðŸ§ª

âœ… Bot Connection Test
ðŸ“… Date: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
ðŸ”§ Source: GitHub Actions

ðŸ“¤ Status: Testing...
ðŸŽ¯ Channel: Daily Exam Dose

If you see this, bot is working!
"""

data = {
    "chat_id": CHAT_ID,
    "text": message,
    "parse_mode": "Markdown"
}

try:
    url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
    response = requests.post(url, json=data, timeout=10)
    result = response.json()
    
    print(f"ðŸ“Š Response Status: {response.status_code}")
    print(f"ðŸ“„ Response: {json.dumps(result, indent=2)}")
    
    if result.get('ok'):
        print("âœ… SUCCESS: Message sent to Telegram!")
        print(f"ðŸ“ Message ID: {result['result']['message_id']}")
    else:
        print(f"âŒ FAILED: {result.get('description')}")
        
except Exception as e:
    print(f"âŒ Error sending message: {e}")
EOF
          
          # Run the test script
          python test_telegram.py
          
      - name: âœ… Success Report
        if: success()
        run: |
          echo "ðŸŽ‰ Test completed successfully!"
          echo "ðŸ“¤ Check your Telegram channel for the test message"
          
      - name: âŒ Error Report
        if: failure()
        run: |
          echo "âš ï¸ Test failed!"
          echo "ðŸ”§ Check the logs above for details"
